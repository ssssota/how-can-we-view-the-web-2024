---
marp: true
---

# Webページが表示されるまで

第1回 SSRってなんだっけ

---

## どうやってWebページは表示されているのか

モダンなWebページは、描画などの手法が多岐にわたり複雑。

- SSR / CSR / SSG / ISR ...
- SPA / MPA

過去から現在に至るまでを振り返りながら、各手法の特徴を整理していく。

それぞれの単語を一言で説明するのは無理なので、「これはSSRだ」などと判断できるようになることを目指す。

---

## 原初のWebページ

1990年代にTim Berners-LeeによってWWWが提唱され、HTMLが登場。

HTMLをやり取りするプロトコルとしてHTTPが登場し、Webページの表示が可能になった。

当時は、静的なファイルをHTTPサーバーから取得して表示するだけの単純なものだった。研究者向けのドキュメント交換のためのものが、次第に一般に普及していった。

```
┌───────┐       ┌───────┐
│Browser├──────►│HTTP   │
│       │◄──────┤Server │
└───────┘       └───────┘
```

---

## CGIの登場

一般への普及とともに、Webページの内容を動的に生成したくなってきた。

そこで、CGI (Common Gateway Interface) が登場。

PerlやC言語などで書かれたプログラムをWebサーバーと連携させ、動的にWebページを生成することが可能になった。
Webサーバーは、リクエストに応じてCGIプログラムを実行し、その結果をクライアントに返す。

```
┌───────┐       ┌───────┐       ┌───────┐
│Browser├──────►│HTTP   ├──────►│CGI    │
│       │◄──────┤Server │◄──────┤Program│
└───────┘       └───────┘       └───────┘
```

---

## PHPの登場

CGIプログラム自体はHTTPが喋れないため、Webサーバーが別途必要だった。

PHPはそれ自体がWebサーバーとして動作する(=HTTPが喋れる)ようになりWebサーバーとCGIプログラムが一体化し、パフォーマンスなどが向上した。

```
┌───────┐       ┌───────┐
│Browser├──────►│PHP    │
│       │◄──────┤Server │
└───────┘       └───────┘
```

---

## Ajaxの登場

2000年代に入ると、ページ内の動的な更新が求められるようになった。

Ajax (Asynchronous JavaScript and XML) が登場し、Webページの一部分だけを更新することが可能になった。

JavaScriptを使ってサーバーからデータ(XML/JSON)やHTMLを取得し、ページの一部を更新する。

```
Browser────┬──────────────┬─────────────────►
        req│ ▲        Ajax│ ▲
           ▼ │HTML        ▼ │Data
Server───────┴──────────────┴───────────────►
```

---

## SPAの登場

2000年代後半には、SPA (Single Page Application) が登場。

ページ遷移を行わず、JavaScriptで「ページの一部もしくは全体を更新する」ことで、アプリのようなスムーズな操作感を実現した。
ページ遷移が不要になった結果、サーバーで配信するHTMLは1つになったため、この名前が付いた。

これに対して、従来の複数のHTMLが配信されるような手法はMPA (Multi Page Application) と呼ばれるようになった。

---

## 仮想DOMの登場

SPAの登場により、JavaScriptのコード量が増え、DOM操作が複雑になっていった。

仮想DOM (Virtual DOM) が登場し、宣言的にUIを記述することでDOM操作を抽象化し、コードの保守性を向上させた。
この結果、JavaScriptの操作対象はページの一部から全体へと広がっていった。SPAの進化であり、その普及は加速した。

---

## SSRの登場

HTML全体をJavaScriptで操作するようになった結果、配信されるHTMLはJavaScriptを実行するためだけに存在するハリボテになってしまった。
空のHTMLでは、クローラーは情報を得ることはできず、SEOの観点で問題があった。

SSR (Server Side Rendering)が登場し、サーバーでJavaScriptを実行、HTMLを生成することで、これを解決した。

これに対して、クライアントでJavaScriptを実行してHTMLを生成する手法はCSR (Client Side Rendering) と呼ばれる。

---

## SSG / ISRの登場

SSRでは、ブログなどの静的なコンテンツに対してもサーバーでJavaScriptを実行する必要があり、ロスが生じる。この問題に対して次のような手法が登場。

SSG (Static Site Generation) : ビルド時にHTMLを生成することで、サーバーの負荷を軽減した。

ISR (Incremental Static Regeneration) : 生成したHTMLをキャッシュし、条件次第で再生成することで、リアルタイム性とパフォーマンスを両立した。（ただのキャッシュ）

「いずれもSSRの一種であり、サーバーでHTMLを生成する手法である」と言っても過言ではない。

---

## よくある勘違い1

> SPA (Sigle Page Application) とCSR (Client Side Rendering) はどちらもクライアント側でJavaScriptを実行してHTMLを生成する手法で、おなじことを指している。

SPAは、JavaScriptで **ページ遷移を再現している** というところがポイント。
CSRは、JavaScriptで **HTMLを組み立てている** というところがポイント。

---

## よくある勘違い2

> CGIはSSR (Server Side Rendering) の一種である

広義のSSRであると言えなくもないが、一般的には違う。

SSRのキモは、 **サーバーでJavaScriptを実行** していること。
また、その **JavaScriptをクライアントでも再利用（実行）** できること。

~~SSRという名前が**本当に**わかりづらい。センスない~~

---

## よくある勘違い?3

> 全てのページをSSRしている = MPAである

SSRにより、それぞれのページをサーバーで生成していても、JavaScriptでページ遷移を再現していることがある。この場合、SPAであると言える。

SPA/MPAは、実際にHTMLが複数あるかではなく、**ページ遷移の手法**と捉えると自然。
HTMLを読み込む遷移であればMPA(従来)、JavaScriptで遷移する場合はSPAと言える。

（SPAという単語が登場した当初は、実際に1つのHTMLで動作していたが、SSRの台頭により定義が複雑になっている）

---

## Next.js (Pages Router) の例

Next.js では `next/link` というモジュールが提供されている。
これによってページ遷移する場合、クライアントサイドで遷移する(SPA)。

ただし、各ページへ直接アクセスすると、サーバーサイドでHTMLが生成される(SSR)。

それぞれ、 `<a />` タグを使って遷移することでMPAに、 `next/dynamic` モジュールによってCSRにも対応できる。

---

## まとめ

かなりざっくり言うと、以下。

- SPA / MPA
  - ページ遷移の手法
- SSR(,SSG,ISR) / CSR
  - HTMLを生成するJavaScriptの実行場所

SSR+SPA も SSR+MPA も CSR+SPA も存在する。（CSR+MPAはメリットがなさそう）
